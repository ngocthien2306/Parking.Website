@using Modules.Pleiger.CommonModels;
@using Modules.Common.Models;
@using Modules.Admin.Models;
@using InfrastructureCore.Models.Menu;
@using Modules.Pleiger.CommonModels.Models
@{
    Layout = null;
    SYMenuAccess pageSetting = new SYMenuAccess();
    pageSetting.SEARCH_YN = true;
    pageSetting.DELETE_YN = true;


    List<ToolbarInfo> lstNewToolbar = new List<ToolbarInfo>();
    ToolbarInfo info = new ToolbarInfo();
    info.Name = "Reload";
    info.ID = "btnReload";
    info.Icon = "<i class='fas fa-sync'></i>";
    info.MenuID = ViewBag.MenuID;
    lstNewToolbar.Add(info);

    string lessMonth = "lessMonth" + ViewBag.Thread;
    string onceRecently = "onceRecently" + ViewBag.Thread;
    string gridStore = "gridStore" + ViewBag.Thread;
    string gridMember = "gridMember" + ViewBag.Thread;
    string userName = "userName" + ViewBag.Thread;
    string phoneNumber = "phoneNumber" + ViewBag.Thread;


    var approveRejectEntities = new[] {
        new {id = false, name = _loc.GetLocalizedString("Reject")},
        new {id = true, name = _loc.GetLocalizedString("Approve")}
    };

    var lessMonthData = new[] {
        new {id = 0, name = _loc.GetLocalizedString("All visitor")},
        new {id = 1, name = _loc.GetLocalizedString("Visit the last 1 month or less")}
    };

    var onceRecentlyData = new[] {
        new  {id = 0, name = _loc.GetLocalizedString("All visitor")},
        new  {id = 1, name = _loc.GetLocalizedString("Visit less than once recently")}
    };
}


<script>
    var storeNoMemberScreen = null;
    $(document).ready(function () {
        LoadingPage(1);
        LoadStoreMaster(null, null, null, "#@gridStore");
        LoadingPage(0);
    })
    function GridMemberUserInstance() {
        return $("#@gridMember").dxDataGrid("instance");
    }
    function GridStoreMemberInstance() {
        return $("#@gridStore").dxDataGrid("instance");
    }
    // Region: btn click event
    //$('#btnSearch_@(ViewBag.Thread)').on('click', function () {
    //    LoadingPage(1);

    //    LoadingPage(0);
    //});
    function UpdateApproveRejectMemberUser(e) {
        debugger;
        var yes_or_no = DevExpress.ui.dialog.confirm("@(_loc.GetLocalizedString(MessageCode.MD0021))", '@(_loc.GetLocalizedString("Notice"))');
        yes_or_no.done(function (dialogResult) {
            if (dialogResult) {
                debugger;
                var checkins = GridMemberUserInstance().getSelectedRowsData()[0];
                var url = '@Url.Action("UpdateApproveRejectUser", "CheckInHistory")';
                var obj = {
                    userId: checkins.userId,
                    status: e.value
                }
                $.ajax({
                    url: url,
                    type: "GET",
                    data: obj,
                    dataType: 'json',
                    async: false,
                    success: function (result) {
                        debugger;
                        if (result.Success) {

                            DevExpress.ui.notify(
                                {
                                    message: '@_loc.GetLocalizedString("Update approve/reject successfully! Sending information to syschonous on FaceOK. Please wait a second")',
                                    position: {
                                        my: 'bottom right',
                                        at: 'bottom right'
                                    },
                                    width: '30%'
                                },
                                'info',
                                5000
                            );

                            setTimeout(function () {
                                SearchMember();
                            }, 1000);

                            var data = []
                            data.push({ userId: checkins.userId, userName: checkins.userName });
                            if(e.value) {
                                var url = '@Url.Action("RequestAddOnFaceOk", "MemberMgt")';
                                RequestOnFaceOk(data, url);
                            }
                            else {
                                var url = '@Url.Action("RequestDeleteOnFaceOk", "MemberMgt")';
                                RequestOnFaceOk(data, url, false);
                            }
                        }
                        else {
                            DevExpress.ui.dialog.alert(result.Message, "Error");
                        }
                        LoadingPage(0);
                    },
                    error: function () {
                        LoadingPage(0);
                    }
                });

                //CRUDData(url, obj, METHOD.GET);



                setTimeout(function () {
                    var stores = GridStoreMemberInstance().getSelectedRowsData();
                    if (stores.length > 0) {
                        LoadMemberManagement(stores[0].storeNo, null);
                        return;
                    }
                    LoadMemberManagement(null, null);
                }, 1000);
            }
            else {
                debugger;

                GridMemberUserInstance().refresh();

                //setTimeout(function () {
                //    LoadStoreDevice(gridStore.storeNo, null, null, null, null);
                //}, 1000);
            }
        })
    }
    $("#btnReload_@ViewBag.Thread").on("click", function () {
        LoadingPage(1);
        CheckSession();
        RefreshTab(this);
        LoadingPage(0);
    });
    $("#btnSearch_@ViewBag.Thread").on("click", function () {
        LoadingPage(1);
        CheckSession();
        SearchMember();
        LoadingPage(0);
    });

    $("#btnDelete_@ViewBag.Thread").on("click", function () {
        LoadingPage(1);

        var users = GridMemberUserInstance().getSelectedRowsData();
        if (users.length < 1) {
            DevExpress.ui.dialog.alert("@_loc.GetLocalizedString("Please select the user you want to remove!")", "Notice");
            LoadingPage(0);
            return;
        }
        var yes_or_no = DevExpress.ui.dialog.confirm("@(_loc.GetLocalizedString(MessageCode.MD0002))", '@(_loc.GetLocalizedString("Notice"))');
        yes_or_no.done(function (dialogResult) {
            if (dialogResult) {
                debugger;

                var data = []
                users.forEach(u => {
                    data.push({ userId: u.userId, userName: u.userName });
                });

                $.ajax({
                    url: '@Url.Action("DeleteListMember", "MemberMgt")',
                    type: "DELETE",
                    data: {
                        userIds: JSON.stringify(data)
                    },
                    dataType: 'json',
                    async: false,
                    success: function (result) {
                        debugger;
                        if (result.Success) {

                            DevExpress.ui.notify(
                                {
                                    message: '@_loc.GetLocalizedString("Delete member successfully! Sending information to syschonous on FaceOK. Please wait a second")',
                                    position: {
                                        my: 'bottom right',
                                        at: 'bottom right'
                                    },
                                    width: '30%'
                                },
                                'info',
                                5000
                            );
                            
                            var url = '@Url.Action("RequestDeleteOnFaceOk", "MemberMgt")';
                            RequestOnFaceOk(result.Data, url, true);
                        }
                        else {
                            DevExpress.ui.dialog.alert(result.Message, "Error");
                        }
                        LoadingPage(0);
                    },
                    error: function () {
                        LoadingPage(0);
                    }
                });
                
                //CRUDData(url, obj, METHOD.DELETE);

            }
        })
        LoadingPage(0);
        setTimeout(function () {
            SearchMember();
        }, 1000);

    })

    function SearchMember() {
        var obj = {
            storeNo: storeNoMemberScreen,
            lessMonth: GetDataElement("#@lessMonth"),
            onceRecently: GetDataElement("#@onceRecently"),
            phoneNumber: GetDataElement("#@phoneNumber"),
            username: GetDataElement("#@userName"),
        }
        var url = '@Url.Action("GetMemberManagement", "MemberMgt")';
        LoadGridData(url, obj, "#@gridMember", METHOD.POST);
    }

    function SearchMemberLessMonth(e) {
        debugger;

        //var obj = {
        //    storeNo: storeNoMemberScreen,
        //    lessMonth: e.selectedItem.id
        //}
        //var url = '@Url.Action("GetMemberManagement", "MemberMgt")';
        //LoadGridData(url, obj, "#@gridMember", METHOD.POST);
    }

    function SearchMemberOnceRecently(e) {
        debugger;

        //var obj = {
        //    storeNo: storeNoMemberScreen,
        //    onceRecently: e.selectedItem.id
        //}
        //var url = '@Url.Action("GetMemberManagement", "MemberMgt")';
        //LoadGridData(url, obj, "#@gridMember", METHOD.POST);
    }
    // End Region: btn click event

    // Region: Get Data
    function ShowMemberSelection(e) {
        LoadingPage(1);
        CheckSession();
        GetGridIntance("#@gridMember").selectRows();
        LoadMemberManagement(e.data.storeNo, null);
    }

    function LoadMemberManagement(storeNo, userId) {
        storeNoMemberScreen = storeNo
        var obj = {
            storeNo: storeNo,
            userId: userId,
            lessMonth: GetDataElement("#@lessMonth"),
            onceRecently: GetDataElement("#@onceRecently")
        }
        var url = '@Url.Action("GetMemberManagement", "MemberMgt")';
        LoadGridData(url, obj, "#@gridMember", METHOD.POST);
    }
    // Show popup member detail
    function ShowMemberDetailMgt(e) {
        LoadingPage(1);
        CheckSession();
        debugger;
        ShowMemberMgtDetail(e.data.storeNo, e.data.userId);
        LoadingPage(0);
    }

    function ShowMemberMgtDetail(storeNo, userId) {
        var url = '@Url.Action("ShowMemberDetailMgt", "MemberMgt")';
        var obj = {
            storeNo: storeNo,
            userId: userId,
            viewbagIndex: '@ViewBag.Thread',
            menuParent: '@ViewBag.MenuId'
        }
        OpenPopup(url, obj, METHOD.GET);
    }
    // End Region: Get Data
</script>

<div id="menutoolbar_@(ViewBag.Thread)">
    @await Component.InvokeAsync("AccessToolbar", new { pageSetting = pageSetting, lstNewToolbar = lstNewToolbar, threadID = ViewBag.Thread })
</div>

<div class="row" id="divindex_@(ViewBag.Thread)">
    <div class="col-md-12" style="width:100%;height:100%;">
        <div class="card" style="height:100%;width:100%;">
            <div id="headerpage_@(ViewBag.Thread)" class="card-header">
                <div class="row">
                    <div class="col-md-6">
                        <label>@(_loc.GetLocalizedString("Recently"))</label>
                        <div class="row mt-1">
                            <div class="form-group col-md-4">
                                @(Html.DevExtreme().SelectBox()
                            .DataSource(lessMonthData)
                            .Value(0)
                            .DisplayExpr("name")
                            .ValueExpr("id")
                            .ID(lessMonth)
                            .OnSelectionChanged("SearchMemberLessMonth")
                            )
                            </div>
                            <span class="mt-2">@(_loc.GetLocalizedString("Months of non-entry")) </span>
                            <span class="mt-2"> ~</span>
                            <div class="form-group col-md-4">
                                @(Html.DevExtreme().SelectBox()
                            .ID(onceRecently)
                            .Value(0)
                            .DataSource(onceRecentlyData)
                            .DisplayExpr("name")
                            .ValueExpr("id")

                            .OnSelectionChanged("SearchMemberOnceRecently")
                            )
                            </div>
                            <span class="mt-2">@(_loc.GetLocalizedString("Less than one entry"))</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label>@(_loc.GetLocalizedString("Username"))</label>
                        <div class="form-group mt-1">
                            @(Html.DevExtreme()
                                    .TextBox()
                                    .ID(userName)
                                )
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label>@(_loc.GetLocalizedString("Phone Number"))</label>
                        <div class="form-group mt-1">
                            @(Html.DevExtreme()
                                    .TextBox()
                                    .ID(phoneNumber)
                                )
                        </div>
                    </div>
                </div>
            </div>
            <div id="bodypage_@(ViewBag.Thread)" class="mr-2 ml-2" style="height:100%">
                <div class="row" style="height:75vh">
                    <div class="col-md-3">
                        @(
                            Html.DevExtreme().DataGrid<KIO_StoreMaster>()
                            .ID(gridStore)
                            .Height("70vh")
                            .ShowBorders(true)
                            .ShowColumnLines(true)
                            .HeaderFilter(f => f.Visible(true))
                            .FilterRow(f => f.Visible(true))
                            .ShowRowLines(true)
                            .AllowColumnResizing(true)
                            .AllowColumnReordering(true)
                            .RemoteOperations(true)
                            .ColumnAutoWidth(true)
                            .ColumnFixing(c => c.Enabled(true))
                            .RepaintChangesOnly(true)
                            .Selection(s => s.Mode(SelectionMode.Single))
                            .Columns(c =>
                            {
                                c.AddFor(x => x.locationName).Caption(_loc.GetLocalizedString("Location"));
                                c.AddFor(x => x.storeName).Caption(_loc.GetLocalizedString("Store Name"));
                                c.AddFor(x => x.openDate).Caption(_loc.GetLocalizedString("Open Date")).Format("yyyy-MM-dd");
                            })

                            .Pager(pager =>
                            {
                                pager.ShowInfo(true);
                                pager.ShowNavigationButtons(true);
                            })
                            //.OnSelectionChanged("ShowMemberSelection")
                            .OnRowClick("ShowMemberSelection")
                            //.OnToolbarPreparing("onItemGridToolbarPreparing")
                            //.Paging(paging => paging.PageSize(100))
                            )
                    </div>
                    <div class="col-md-9">
                        @(
                            Html.DevExtreme().DataGrid<KIO_SubscriptionHistory>()
                            .ID(gridMember)
                            .Height("70vh")
                            .ShowBorders(true)

                            .ShowColumnLines(true)
                            .HeaderFilter(f => f.Visible(true))
                            .FilterRow(f => f.Visible(true))
                            .ShowRowLines(true)
                            .AllowColumnResizing(true)
                            .AllowColumnReordering(true)
                            .RemoteOperations(true)
                            .ColumnAutoWidth(true)
                            .ColumnFixing(c => c.Enabled(true))
                            .Scrolling(s => s.Mode(GridScrollingMode.Infinite))
                            .RepaintChangesOnly(true)
                            .Selection(s => s.Mode(SelectionMode.Multiple))
                            .Columns(c =>
                            {
                                c.AddFor(x => x.no).Caption(_loc.GetLocalizedString("No"));

                                c.Add().Caption(_loc.GetLocalizedString("Store Information")).Alignment(0).Columns(columns =>
                                {
                                    columns.AddFor(x => x.locationName).Caption(_loc.GetLocalizedString("Location"));
                                    columns.AddFor(x => x.storeName).Caption(_loc.GetLocalizedString("Store Name"));
                                });
                                c.Add().Caption(_loc.GetLocalizedString("Member Information")).Alignment(0).Columns(columns =>
                                {
                                    columns.AddFor(x => x.userName).Caption(_loc.GetLocalizedString("Username"));
                                    columns.AddFor(x => x.birthday).Caption(_loc.GetLocalizedString("Birthday")).Format("yyyy-MM-dd").Alignment(0);
                                    columns.Add().Caption(_loc.GetLocalizedString("Gender")).CalculateCellValue(@<text>
                                        function(data) {
                                            return data.gender == true ? "@_loc.GetLocalizedString("Men")" : "@_loc.GetLocalizedString("Women")";
                                        }
                                    </text>);
                                    columns.AddFor(x => x.phoneNumber).Caption(_loc.GetLocalizedString("Phone Number"));
                                    columns.AddFor(x => x.registDate).Caption(_loc.GetLocalizedString("Registered Date")).Format("yyyy-MM-dd HH:mm:ss").Alignment(0);
                                });
                                c.Add().Caption(_loc.GetLocalizedString("Approval Information")).Alignment(0).Columns(columns =>
                                {
                                    columns.Add().Caption(_loc.GetLocalizedString("Approve Reject")).CellTemplate(@<text>
                                        @(
                                        Html.DevExtreme().RadioGroup()
                                        .DataSource(approveRejectEntities)
                                        .ValueExpr("id")
                                        .DisplayExpr("name")
                                        .Value(new JS("data.approveReject"))
                                        .Layout(Orientation.Horizontal)
                                        .OnValueChanged("UpdateApproveRejectMemberUser")

                                        )
                                        </text>);
                                    columns.AddFor(x => x.approvalType).Caption(_loc.GetLocalizedString("Approval Type"));
                                    columns.AddFor(x => x.lastSimilarity).Caption(_loc.GetLocalizedString("Rate Similarity")).Format(Format.FixedPoint);

                                    columns.AddFor(x => x.userStatus).Caption(_loc.GetLocalizedString("Status")).Visible(false);
                                });
                            })

                            .Pager(pager =>
                            {
                                pager.ShowInfo(true);
                                pager.ShowNavigationButtons(true);
                            })
                            //.OnSelectionChanged("onItemGridSelectionChanged")
                            .OnRowDblClick("ShowMemberDetailMgt")
                            //.OnToolbarPreparing("onItemGridToolbarPreparing")
                            //.Paging(paging => paging.PageSize(100))
                            )
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

