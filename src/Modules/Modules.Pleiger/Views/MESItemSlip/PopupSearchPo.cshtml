@using Modules.Pleiger.Models;
@using Modules.Common.Models;

@model MES_SaleProject;
@{
    Layout = null;
    var priorities = new[] { "True", "False" };
}
@{
    string gridItemPoMst = "gridItemPoMst" + ViewBag.Thread;
    string UserPONumber = "UserPONumber" + ViewBag.Thread;
    string PartnerName = "PartnerName" + ViewBag.Thread;
    string btnChoosePO = "btnChoosePO" + ViewBag.Thread;
}
    <script>
        $(document).ready(function () {
            LoadingPage(1);
            $("#btnSave_@ViewBag.Thread").attr("disabled", true);
            CheckSession();
            $.ajax({
                url: '@Url.Action("GetPOAllNumberSearch", "MESItemSlip")',
                type: 'GET',
                async: false,
                data:
                {
                    UserPONumber: "",
                    PartnerCode: "",
                },
                dataType: 'json',
                success: function (result) {
                    debugger;
                    var grid = $("#gridItemPoMst@(ViewBag.Thread)").dxDataGrid("instance");
                    grid.option("dataSource", result.data);
                    LoadingPage(0);

                }, error: function (result) {
                    LoadingPage(0);
                    return;
                }
            });
            LoadingPage(0);
        });

        function SearchItemPoMst() {
            LoadingPage(1);
            CheckSession();
            debugger;
            var UserPONumber = $('#@UserPONumber').dxTextBox('option', 'value');
            var PartnerName = $('#@PartnerName').dxTextBox('option', 'value');

            $.ajax({
                url: '@Url.Action("GetPOAllNumberSearch", "MESItemSlip")',
                type: 'GET',
                async: false,
                data:
                {
                    UserPONumber: UserPONumber,
                    PartnerName: PartnerName
                },
                dataType: 'json',
                success: function (result) {
                    debugger;
                    var grid = $("#gridItemPoMst@(ViewBag.Thread)").dxDataGrid("instance");
                    grid.option("dataSource", result.data);
                    LoadingPage(0);
                }, error: function (result) {
                    LoadingPage(0);
                    return;
                }
            });
            LoadingPage(0);
        }

        function ItemPoPopupSelectionChanged(e) {
            CheckSession();
            debugger;
            var rowdata = e.data;
            //Set data from Popup to Index
            //clear in form
            clearFormWhenChangePONumber();
            //
            $('#PONumberPopup@(ViewBag.Index)').val(rowdata.PONumber);
            $('#UserPONumberPopup@(ViewBag.Index)').val(rowdata.UserPONumber);
            $('#PartnerCode@(ViewBag.Index)').val(rowdata.PartnerCode);
            $('#PartnerName@(ViewBag.Index)').val(rowdata.PartnerName);
            $('#ProjectCode@(ViewBag.Index)').val(rowdata.ProjectCode);
            partnerCodeSlt = rowdata.PartnerCode;
            //select Podetail
            $.ajax({
                url: '@Url.Action("CreateGridItemSlipDtlByPONumber", "MESItemSlip")',
                type: "GET",
                data: { PONumber: rowdata.PONumber },
                dataType: 'json',
                success: function (result) {
                    debugger;
                    var gridItemSlipDetail = $("#gridItemSlipDtl@(ViewBag.Index)").dxDataGrid("instance");
                    gridItemSlipDetail.option("dataSource", result.data);
                }
            });
            //close popup
            $('#modalControl').modal('hide');
        }

        $('#btnChoosePO@(ViewBag.Thread)').on("click", function () {
            debugger;
            var dataGrid = $('#@gridItemPoMst').dxDataGrid('instance');
            var rowdata = dataGrid.getSelectedRowsData();
            // var listItemSelect = dataGrid.getSelectedRowsData();
            if (rowdata.length == 0) {
                DevExpress.ui.dialog.alert("Please select row!", "Error");
                return;
            }
            else
            {
                $('#PONumberPopup@(ViewBag.Index)').val(rowdata[0].PONumber);
                $('#UserPONumberPopup@(ViewBag.Index)').val(rowdata[0].UserPONumber);
                $('#PartnerCode@(ViewBag.Index)').val(rowdata[0].PartnerCode);
                $('#PartnerName@(ViewBag.Index)').val(rowdata[0].PartnerName);
                $('#ProjectCode@(ViewBag.Index)').val(rowdata[0].ProjectCode);
                partnerCodeSlt = rowdata[0].PartnerCode;
                //select Podetail
                $.ajax({
                    url: '@Url.Action("CreateGridItemSlipDtlByPONumber", "MESItemSlip")',
                    type: "GET",
                    data: { PONumber: rowdata[0].PONumber },
                    dataType: 'json',
                    success: function (result) {
                        debugger;
                        var gridItemSlipDetail = $("#gridItemSlipDtl@(ViewBag.Index)").dxDataGrid("instance");
                        gridItemSlipDetail.option("dataSource", result.data);
                    }
                });
                //close popup
                $('#modalControl').modal('hide');
            }
        });
    </script>

<div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title" id="SalesProjectCreatePopup">@(_loc.GetLocalizedString("Purchase Order List"))</h5>@*--영업프젝트관리*@
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <form id="frm-SaleSetting2">
        <div class="modal-body pt-0">
            <div class="card py-1 mb-0">
                <div class="row">
                    <div class="col-xs-12 col-md-12">
                        <button class="btn btn-sm btn-primary btn-action" type="button" onclick="SearchItemPoMst()" style="margin-right:5px"><i class="fa fa-search"></i> @_loc.GetLocalizedString("Search")</button>
                        <button class="btn btn-sm btn-primary btn-action" type="button" id="@(btnChoosePO)" style="margin-right:5px"><i class="fa fa-check"></i> @_loc.GetLocalizedString("Choose")</button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <fieldset class="customFieldset">
                        <legend class="customLegend">@_loc.GetLocalizedString("Order Information")</legend>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group ">
                                    <label>@(_loc.GetLocalizedString("UserPONumber"))</label>
                                    @(Html.DevExtreme().TextBox().ID(UserPONumber))
                                    @*@(Html.DevExtreme().SelectBox()
                                    .ID(UserPONumber)
                                    .DisplayExpr("UserPONumber")
                                    .ValueExpr("PONumber")
                                    .DataSource(d => d.Mvc()
                                    .Controller("MESItemSlip")
                                        .LoadAction("GetPOAllNumberForRelease")
                                        .Key("PONumber")
                                    )
                                    .ShowClearButton(true)
                                    .SearchEnabled(true)
                                    .DataSourceOptions(o => o.Paginate(true).PageSize(100))//async load more
                                    .AcceptCustomValue(true)
                                )*@
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group ">
                                    <label>@(_loc.GetLocalizedString("Partner Name"))</label>
                                    @(Html.DevExtreme().TextBox().ID(PartnerName))
                                    @*@(Html.DevExtreme().SelectBox()
                                .ID(PartnerCode)
                                .DisplayExpr("PartnerName")
                                .ValueExpr("PONumber")
                                .DataSource(d => d.Mvc()
                                .Controller("MESItemSlip")
                                    .LoadAction("GetPOAllNumberForRelease")
                                    .Key("PONumber")
                                )
                                .ShowClearButton(true)
                                .SearchEnabled(true)
                                .DataSourceOptions(o => o.Paginate(true).PageSize(100))//async load more
                                .AcceptCustomValue(true)*@

                                </div>
                            </div>
                            @*<div class="col-md-2">
                            <div class="form-group">
                                <label style="visibility:hidden">@(_loc.GetLocalizedString("UserProjectCode"))</label>
                                @(Html.DevExtreme().Button()
                                    .Text(_loc.GetLocalizedString("Search")).Icon("fa fa-search")
                                    .Type(ButtonType.Normal)
                                    .Width(150)
                                    .StylingMode(ButtonStylingMode.Contained).OnClick("SearchItemPoMst"))
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label style="visibility:hidden">@(_loc.GetLocalizedString("UserProjectCode"))</label>
                                @(Html.DevExtreme().Button()
                                     .Text(_loc.GetLocalizedString("Choose")).Icon("fa fa-check")
                                     .ID("btnChoosePO"+ ViewBag.thread)
                                     .Type(ButtonType.Default)
                                     .Width(150)
                                )
                            </div>
                        </div>*@
                        </div>
                    </fieldset>
                </div>
            </div>
            <div class="form-group">
                <fieldset class="customFieldset">
                    <legend class="customLegend">@_loc.GetLocalizedString("Purchase Order List")</legend>
                    @(Html.DevExtreme().DataGrid<MES_ItemSlipMaster>()
                                    .ID(gridItemPoMst)
                                    .ShowBorders(true)
                                    .ShowColumnLines(true).Height(450)
                                    .ShowRowLines(true)
                                    .ColumnAutoWidth(true)
                                    .FilterRow(filterRow => filterRow
                                    .Visible(true)
                                    .ApplyFilter(GridApplyFilterMode.Auto))
                                    .RepaintChangesOnly(true)
                                    .Selection(s => s.Mode(SelectionMode.Single)
                                    .ShowCheckBoxesMode(GridSelectionShowCheckBoxesMode.Always)
                                    .SelectAllMode(SelectAllMode.AllPages))
                                    .Columns(c=>
                                    {

                                        c.AddFor(x => x.No).Caption(_loc.GetLocalizedString("No"));
                                        c.AddFor(x => x.PONumber).Caption(_loc.GetLocalizedString("PONumber")).Visible(false);//PO NUMBER
                                        c.AddFor(x => x.UserPONumber).Caption(_loc.GetLocalizedString("UserPONumber"));
                                        c.AddFor(x => x.TotalPrice).Caption(_loc.GetLocalizedString("TotalPrice")).Format("#,##0.#0").Visible(false);//total
                                        //show xem
                                        c.AddFor(x => x.TotalReceivedQty).Caption(_loc.GetLocalizedString("Total Qty Received"));//total
                                        c.AddFor(x => x.TotalPOQty).Caption(_loc.GetLocalizedString("Total PO Qty"));


                                        c.AddFor(x => x.PartnerCode).Caption(_loc.GetLocalizedString("Partner Code")).Alignment(HorizontalAlignment.Center);//PARNERT CODE
                                        c.AddFor(x => x.PartnerName).Caption(_loc.GetLocalizedString("Partner Name"));//PARTNER NAME
                                        c.AddFor(x => x.ProjectCode).Caption(_loc.GetLocalizedString("Project Code")).Visible(false);//PROJECT CODE


                                    })
                                    .Scrolling(s => s.Mode(GridScrollingMode.Virtual))
                                    .HeaderFilter(f => f.Visible(true))
                                    .Paging(paging => paging.PageSize(100))
                                    .Pager(pager =>
                                    {
                                        pager.ShowInfo(true);
                                        pager.ShowNavigationButtons(true);
                                    })
                                    .OnRowDblClick("ItemPoPopupSelectionChanged")
                  )
                </fieldset>
            </div>
        </div>
    </form>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">@(_loc.GetLocalizedString("Close"))</button>
    </div>
</div>
