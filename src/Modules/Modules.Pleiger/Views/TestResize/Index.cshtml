@using Modules.Pleiger.Models;
@using InfrastructureCore.Models.Menu;
@using Modules.Admin.Models;
@using Modules.Common.Models;
@{
    Layout = null;
    string checkUserType = ViewBag.CheckUserType;
    SYMenuAccess pageSetting = new SYMenuAccess();
    pageSetting.SEARCH_YN = true;
    if (checkUserType.Equals("G000C005"))
    {
        pageSetting.CREATE_YN = false;
    }
    else
    {
        pageSetting.CREATE_YN = true;
    }

    //pageSetting.SAVE_YN = true;
    pageSetting.EXCEL_YN = true;
    pageSetting.DELETE_YN = true;

    List<ToolbarInfo> lstNewToolbar = new List<ToolbarInfo>();
    ToolbarInfo info = new ToolbarInfo();
    info.Name = "Reload";
    info.ID = "btnReload";
    info.Icon = "<i class='fas fa-sync'></i>";
    info.MenuID = ViewBag.MenuID;
    lstNewToolbar.Add(info);

    string gridPORequest = "gridPORequest";

    string showOverSea = "";

    if (ViewBag.partnerCountry != null && ViewBag.partnerCountry != "")
    {
        //case => internal , oversea
        if (ViewBag.partnerCountry == "CTTP01")
        {
            showOverSea = "no";
        }
        else if (ViewBag.partnerCountry == "CTTP02")
        {
            showOverSea = "yes";
        }
    }
    else
    {
        //show all
        showOverSea = "yes";
    }

}

<script>

    //function setHeightAutoResize() {
    //    var divTabLinkHeight = $("#divTabLink").height();
    //    var divToolbarHeight = divTabLinkHeight;
    //    var divSearchRegionHeight = $("#divTabContent .region-search").height();
    //    var divFooterHeight = $(".main-footer").height();
    //    var total = $(window).height() - (divTabLinkHeight + divToolbarHeight + divSearchRegionHeight + divFooterHeight);
    //    var regionGridHeight = $(".region-grid").height(total);
    //}
    $(document).ready(function () {


        $("#btnDelete_@ViewBag.Thread").prop("disabled", true);
        function setGridHeight() {
            debugger;
            var divTabLinkHeight = $(".content #divTabLink").height();
            var regionsearchmain = $(".content .region-search-main ").height();
            var contentHeight = $(".content").height();
            var gridHeight = contentHeight - (divTabLinkHeight + regionsearchmain);
            console.log("gridHeight", gridHeight);
            return gridHeight;
        }
    });
    $(window).resize(function () {
    });
    // Show detail PO Request
        function ShowDetailPORequest(e) {

            $("#btnDelete_@ViewBag.Thread").prop("disabled", true);
            CheckSession();
            PONumberDelete = "";
            let rowData = e.data;
            debugger;
            $.ajax({
                url: '@Url.Action("ShowDetailPORequest", "MESPORequest")',
                type: "GET",
                data: {
                    projectCode: rowData.ProjectCode,
                    poNumber: rowData.PONumber,
                    partnerCode: rowData.PartnerCode
                },
                dataType: "html",
                success: function (result) {
                    $("#divPORequestDetail").html(null);
                    $("#divPORequestDetail").html(result);
                    $("#divMainPOREquest").prop("hidden", true);
                    $("#divPORequestDetail").prop("hidden", false);
                }
            });
        }

    var PONumberDelete;
    function GetRowDeletePORequest(e) {
        let rowData = e.data;
        debugger;
        if (rowData.StatusCode == "ORST06") {
            $("#btnDelete_@ViewBag.Thread").prop("disabled", false);
            PONumberDelete = rowData.PONumber;
        }
        else {
            $("#btnDelete_@ViewBag.Thread").prop("disabled", true);
            PONumberDelete = "";
        }
    }
      // Reaload tab
        $("#btnDelete_@ViewBag.Thread").on("click", function () {
            CheckSession();
            var result = DevExpress.ui.dialog.confirm("<i>@MessageCode.MD0003</i>", "Confirm changes");
            result.done(function (dialogResult) {
                if (dialogResult) {
                    $.ajax({
                        url: '@Url.Action("DeletePOMst", "MESPORequest")',
                        type: "POST",
                        data:
                        {
                            PONumber: PONumberDelete
                        },
                        dataType: "json",
                        success: function (result) {
                            if (result.Success == true) {
                                DevExpress.ui.dialog.alert('@MessageCode.MD0004', "Success", function () {
                                    var dataGridPOMst = $("#@(gridPORequest)").dxDataGrid("instance");
                                    dataGridPOMst.refresh();
                                    $.unblockUI();
                                });
                            }
                            else {
                                $.unblockUI();
                                DevExpress.ui.dialog.alert(result.Message, "Error");
                            }
                        }
                    });
                }
           });
        });

        // Reaload tab
        $("#btnReload_@ViewBag.Thread").on("click", function () {
            CheckSession();
            RefreshTab(this);
        });

        // Search list PO Request
        $("#btnSearch_@ViewBag.Thread").on("click", function () {
            CheckSession();
            $("#btnDelete_@ViewBag.Thread").prop("disabled", true);
            PONumberDelete = "";


            //let projectCode = $("#txtPOSearch_ProjectCode").dxTextBox("option", "value");
            let projectCode = null;
            //let poNumber = $("#txtPOSearch_PONumber").dxTextBox("option", "value");
            let poNumber = null;
            let userPONumber = $("#txtUserPONumber").dxTextBox("option", "value");
            let userProjectCode = $("#txtUserProjectCode@(ViewBag.Thread)").dxTextBox("option", "value");
            function getParamRequestDateFrom() {
                var value = $("#dtpPOSearch_RequestDateFrom").dxDateBox("option", "text");
                return (value !== null && value !== undefined && value!== "" ) ? ParsingDateyyyyMMdd(value)  : "";
            }
            function getParamRequestDateTo() {
                var value = $("#dtpPOSearch_RequestDateTo").dxDateBox("option", "text");
                return (value !== null && value !== undefined && value !== "") ? ParsingDateyyyyMMdd(value) : "";
            }

            $.ajax({
                url: '@Url.Action("SearchListPORequest","MESPORequest")',
                type: 'GET',
                dataType: 'json',
                data: {
                    projectCode: projectCode,
                    poNumber: poNumber,
                    userPONumber: userPONumber,
                    userProjectCode: userProjectCode ,
                    requestDateFrom: getParamRequestDateFrom(),
                    requestDateTo: getParamRequestDateTo()
                },
                success: function (result) {
                    $("#gridPORequest").dxDataGrid("option", "dataSource", result);
                }
            });
    });

    // Create new PO Request
    $("#btnCreate_@ViewBag.Thread").on("click", function () {
        CheckSession();
        $("#btnDelete_@ViewBag.Thread").prop("disabled", true);
        PONumberDelete = "";
        $.ajax({
            url: '@Url.Action("ShowDetailPORequest", "MESPORequest")',
            type: "GET",
            dataType: "html",
            success: function (result) {
                debugger;
                $("#divPORequestDetail").html(null);
                $("#divPORequestDetail").html(result);
                $("#divMainPOREquest").prop("hidden", true);
                $("#divPORequestDetail").prop("hidden", false);
            }
        })
    });

    // to mau cho arrival request date
    function colorArrivalRequestDate(e) {
        if (e.cells[7].rowType === "data" && e.cells[7].value !== null && e.cells[7].value !== ""){
            var ArrivalRequestDate = new Date(e.cells[7].value );
        }
        if (e.cells[9].rowType === "data" && e.cells[9].value !== null && e.cells[9].value !== ""){
            var AcceptDate = new Date(e.cells[9].value);
        }
        if (ArrivalRequestDate !== "" && AcceptDate !== ""){
            if (ArrivalRequestDate < AcceptDate) {
                e.cells[7].cellElement.css("color", "red");
                e.cells[7].cellElement.css("backgroundColor", "yellow");
            }
        }
        // Quan add 2020/09/03
        // Set color RealArrivalReqDate
        // if ArrivalRequestDate < RealArrivalReqDate
        debugger;
        if (e.cells[8].rowType === "data" && e.cells[8].value !== null && e.cells[8].value !== "") {
            var RealArrivalReqDate = new Date(e.cells[8].value);
        }
        if (ArrivalRequestDate !== "" && RealArrivalReqDate !== "") {
            if (ArrivalRequestDate < RealArrivalReqDate) {
                e.cells[8].cellElement.css("color", "red");
                e.cells[8].cellElement.css("backgroundColor", "yellow");
            }
        }
    }

    $('#btnExcel_@ViewBag.Thread').on("click", function () {
        CheckSession();
        $("#btnDelete_@ViewBag.Thread").prop("disabled", true);
        PONumberDelete = "";
        var dataGrid = $("#@(gridPORequest)");
        ExportExcelCommon(dataGrid, "PORequest")
    });


</script>

@* start test form *@
@*<div class="row">
        <div class="col-xs-12 col-md-12">
            <div class="title-search d-flex pl-0 pt-0">
                <div class="title-text ">Search</div>
                <div class="title">Tìm đơn hàng</div>
                <div class="toggle-form-search">
                    <button class="btn btn-sm btn-action-toggle"><i class="fas fa-minus"></i></button>
                </div>
            </div>
        </div>
        <div class="col-xs-12 col-md-12">
            <div class="region-search-main">
                <div class="col-xs-12 col-md-12">
                    <div class="row">
                        <div class="col-xs-12 col-md-12">
                            <div class="region-search-toolbar">
                                <div class="container-icons-search d-flex flex-wrap ">
                                    <div class="toolbar-group-icons">

                                        <button class="btn btn-sm btn-action" title="Back"><i class="fas fa-reply"></i></button>
                                    </div>
                                    <div class="toolbar-group-icons">

                                        <button class="btn btn-sm btn-action" title="Reload"><i class="fas fa-sync"></i></button>
                                    </div>
                                    <div class="toolbar-group-icons">

                                        <button class="btn btn-sm btn-action" title="Search"><i class="fa fa-search"></i></button>
                                    </div>
                                    <div class="vertical-devider"></div>
                                    <div class="toolbar-group-icons">

                                        <button class="btn btn-sm btn-action" title="Save"><i class="fa fa-save"></i></button>
                                    </div>
                                    <div class="toolbar-group-icons">

                                        <button class="btn btn-sm btn-action" title="Update"><i class="fa fa-save"></i></button>
                                    </div>
                                    <div class="toolbar-group-icons">

                                        <button class="btn btn-sm btn-action" title="Request"><i class="fa fa-save"></i></button>
                                    </div>
                                    <div class="vertical-devider"></div>
                                    <div class="toolbar-group-icons">

                                        <button class="btn btn-sm btn-action" title="Print"><i class="fas fa-download"></i></button>
                                    </div>
                                    <div class="toolbar-group-icons">
                                        <div class="overlay-group-icons"></div>
                                        <button class="btn btn-sm btn-action"><i class="fas fa-sync"></i></button>
                                        <button class="btn btn-sm btn-action"><i class="fas fa-sync"></i></button>
                                    </div>
                                    <div class="toolbar-group-icons">
                                        <div class="overlay-group-icons"></div>
                                        <button class="btn btn-sm btn-action"><i class="fas fa-sync"></i></button>
                                        <button class="btn btn-sm btn-action"><i class="fas fa-sync"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12 col-md-12">
                    <div class="row">
                        <div class="col-xs-12 col-md-12 p-0">
                            <div class="form-search-fields ">
                                <div class="row">
                                    <div class="col-xs-12 col-md-7">
                                        <div class="region-search-wrapper-left">
                                            <div class="row">
                                                <div class="col-xs-12 col-md-6 pl-1 ">
                                                    <div class="field-search-items">
                                                        <div class="col-xs-12 col-md-4 d-flex">
                                                            <span class="label-field-search">Khách hàng</span>
                                                        </div>
                                                        <div class="col-xs-12 col-md-4 p-0">
                                                            @(Html.DevExtreme().DateBox().ID("khachhang1")
                                                        )
                                                        </div>
                                                        <div class="col-xs-12 col-md-4 p-0">
                                                            @(Html.DevExtreme().DateBox().ID("khachhang2")
                                                        )
                                                        </div>
                                                    </div>
                                                    <div class="field-search-items">
                                                        <div class="col-xs-12 col-md-4 d-flex">
                                                            <span class="label-field-search">Partner</span>
                                                        </div>
                                                        <div class="col-xs-12 col-md-4 p-0">
                                                            @(Html.DevExtreme().TextBox().ID("par")
                                                            )
                                                        </div>
                                                        <div class="col-xs-12 col-md-4 p-0">
                                                            @(Html.DevExtreme().SelectBox().ID("aa")
                                                        )
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-xs-12 col-md-6 ">
                                                    <div class="field-search-items ">
                                                        <div class="col-xs-12 col-md-4 d-flex">
                                                            <span class="label-field-search">Trạng Thái</span>
                                                        </div>
                                                        <div class="col-xs-12 col-md-4 p-0">
                                                            @(Html.DevExtreme().DateBox().ID("khac")

                                                            )
                                                        </div>
                                                        <div class="col-xs-12 col-md-4 p-0">
                                                            @(Html.DevExtreme().DateBox().ID("trntahi")

                                                            )
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="vertical-devider"></div>
                                    </div>
                                    <div class="col-xs-12 col-md-5">
                                        <div class="region-search-wrapper-right">

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>*@

@* end test form *@




<div id="divMainPOREquest" style="height:100%">
    @await Component.InvokeAsync("AccessToolbar", new { pageSetting = pageSetting, lstNewToolbar = lstNewToolbar, threadID = ViewBag.Thread })
    <div style="width:inherit;height:inherit">
        
        <div class="" style="height:10%;width:100%">
            <div class="row">
                @*<div class="col-md-2">
                        <div class="form-group">
                            <label>@(_loc.GetLocalizedString("Request Date"))</label>
                            @(Html.DevExtreme().DateBox().ID("dtpPOSearch_RequestDateFrom")
                                    .DisplayFormat("yyyy-MM-dd").MaxLength(10)
                                        .ShowClearButton(true)
                                    )
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label style="color:transparent">a</label>
                            @(Html.DevExtreme().DateBox().ID("dtpPOSearch_RequestDateTo").DisplayFormat("yyyy-MM-dd")
                                            .DisplayFormat("yyyy-MM-dd").MaxLength(10)
                                            .ShowClearButton(true)
                                )
                        </div>
                    </div>*@

                <div class="col-md-3">
                    <label>@(_loc.GetLocalizedString("Request Date"))</label>
                    <div class="form-group row">
                        <div class="col-sm-5 col-xs-5">
                            @(Html.DevExtreme().DateBox().ID("dtpPOSearch_RequestDateFrom")
                                .DisplayFormat("yyyy-MM-dd").MaxLength(10)
                                    .ShowClearButton(true)
                                )
                        </div>
                        <div style="align-self: center;">~</div>
                        <div class="col-sm-5 col-xs-5">
                            @(Html.DevExtreme().DateBox().ID("dtpPOSearch_RequestDateTo").DisplayFormat("yyyy-MM-dd")
                                        .DisplayFormat("yyyy-MM-dd").MaxLength(10)
                                        .ShowClearButton(true)
                            )
                        </div>
                    </div>
                </div>


                <div class="col-md-2">
                    <div class="form-group">
                        <label>@(_loc.GetLocalizedString("PO Number"))</label>
                        @(Html.DevExtreme().TextBox().ID("txtUserPONumber")
                                .ShowClearButton(true)
                                )
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label>@(_loc.GetLocalizedString("Project Name"))</label>
                        @(Html.DevExtreme().TextBox().ID("txtUserProjectCode"+ViewBag.Thread).ShowClearButton(true))
                    </div>
                </div>

            </div>
        </div>
        <div class="" style="height: 90%; width: 100%">
            @(Html.DevExtreme().DataGrid<MES_PORequest>()
            .ID("gridPORequest")
            .DataSource(x=>x.Mvc().Controller("MESPORequest").LoadAction("SearchListPORequest"))
            .ShowBorders(true)
            .ShowColumnLines(true)
            .ShowRowLines(true)
            .AllowColumnResizing(true)
            .AllowColumnReordering(true)
            .OnRowPrepared("colorArrivalRequestDate")
            .ColumnAutoWidth(true)
            .FilterRow(filterRow => filterRow
                .Visible(true)
                .ApplyFilter(GridApplyFilterMode.Auto)
            )
            .Columns(c=> {
                c.AddFor(x => x.No).Caption(_loc.GetLocalizedString("No"));
                c.AddFor(x => x.UserProjectCode).Caption(_loc.GetLocalizedString("Project Name")); //UserProjectCode
                c.AddFor(x => x.UserPONumber).Caption(_loc.GetLocalizedString("UserPONumber")); //UserPONumber
                //c.AddFor(x => x.ProjectCode).Caption(_loc.GetLocalizedString("Project Code"));
                c.AddFor(x => x.PartnerCode).Caption("Partner Code").Visible(false);
                c.AddFor(x => x.PartnerName).Caption(_loc.GetLocalizedString("Partner Name"));
                //c.AddFor(x => x.PONumber).Caption(_loc.GetLocalizedString("PONumber"));
                c.AddFor(x => x.TotalPrice).Caption(_loc.GetLocalizedString("TotalPrice")).Format("#,##0.#0");
                c.AddFor(x => x.Status).Caption(_loc.GetLocalizedString("PO Status"));
                c.AddFor(x => x.ArrivalRequestDate).Caption(_loc.GetLocalizedString("Arrival Request Date"));

                c.AddFor(x => x.RealArrivalReqDate).Caption(_loc.GetLocalizedString("RealArrivalReqDate"));
                c.AddFor(x => x.RequestDate).Caption(_loc.GetLocalizedString("Request Date")); // PO Req Date
                c.AddFor(x => x.UserRequest).Caption(_loc.GetLocalizedString("User Request"));
                c.AddFor(x => x.AcceptDate).Caption(_loc.GetLocalizedString("Accept Date"));
                c.AddFor(x => x.UserAccept).Caption(_loc.GetLocalizedString("User Accept"));
                c.AddFor(x => x.RejectDate).Caption(_loc.GetLocalizedString("Reject Date"));
                c.AddFor(x => x.UserReject).Caption(_loc.GetLocalizedString("User Reject"));

                //add for SeaPO -> check if partner and systemusertype must be partner -> show info
                c.AddFor(x => x.OrderConfirmNumber).Caption(_loc.GetLocalizedString("OrderConfirmNumber")).Visible(showOverSea=="yes"?true:false);
                c.AddFor(x => x.HullNo).Caption(_loc.GetLocalizedString("HullNo")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.BusinessType).Caption(_loc.GetLocalizedString("BusinessType")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.ConnectionToDemand).Caption(_loc.GetLocalizedString("ConnectionDemand")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.Yard).Caption(_loc.GetLocalizedString("Yard")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.Schedule).Caption(_loc.GetLocalizedString("Schedule")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.Mon).Caption(_loc.GetLocalizedString("Mon")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.SPPR).Caption(_loc.GetLocalizedString("SPPR")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.SPPriceRef).Caption(_loc.GetLocalizedString("SPPriceRef")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.RequestShipMode).Caption(_loc.GetLocalizedString("RequestShipMode")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.FinalShipmentMode).Caption(_loc.GetLocalizedString("FinalShipmentMode")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.BLCode).Caption(_loc.GetLocalizedString("BLCode")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.Invoice).Caption(_loc.GetLocalizedString("Invoice")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.InvoiceIssuedDate).Caption(_loc.GetLocalizedString("InvoiceIssuedDate")).Visible(showOverSea == "yes" ? true : false)
                    .DataType(GridColumnDataType.Date).Format("yyyy-MM-dd");
                c.AddFor(x => x.PartnerUser).Caption(_loc.GetLocalizedString("PartnerUser")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.Packing).Caption(_loc.GetLocalizedString("Packing")).Visible(showOverSea == "yes" ? true : false);
                c.AddFor(x => x.RefNumber).Caption(_loc.GetLocalizedString("RefNumber")).Visible(showOverSea == "yes" ? true : false);
            })
                .Scrolling(s => s.Mode(GridScrollingMode.Standard))
                .HeaderFilter(f => f.Visible(true))
                .Paging(paging => paging.PageSize(100))
                .Pager(pager =>
                {
                    //pager.ShowPageSizeSelector(false);
                    //pager.AllowedPageSizes(new[] { 20, 50, 100 });
                    pager.ShowInfo(true);
                    pager.ShowNavigationButtons(true);
                })
                .OnRowDblClick("ShowDetailPORequest")
                .OnRowClick("GetRowDeletePORequest")
                .Selection(s => s.Mode(SelectionMode.Single))
                )

        </div>
    </div>
</div>
<div id="divPORequestDetail" hidden>

</div>
