@using Modules.UIRender.Models;
@using Modules.Admin.Models;
@using InfrastructureCore.Models.Menu
@model DynamicPopupModel
@{
    Layout = null;
    //Add Readload Button
    List<ToolbarInfo> lstNewToolbar = new List<ToolbarInfo>();
    ToolbarInfo info = new ToolbarInfo();
    info.Name = _loc.GetLocalizedString("Excel Template");
    info.ID = "btnDownloadTemplate";
    info.Icon = "<i class='fas fa-download'></i>";
    //info.MenuID = ViewBag.MenuID;
    lstNewToolbar.Add(info);

    SYMenuAccess pageSetting = new SYMenuAccess();
    pageSetting.SAVE_YN = true;
}
@{
    string modelId = Model.PAG_ID + "_" + Model.ACT_ID;
    string UploadFileID = "UploadFile_" + Model.PAG_ID + "_" + Model.ACT_ID;
}

<script>
    var fileLocation = "";
    $("#btnSave_@ViewBag.Thread").on("click", function () {
        debugger;

        console.log('@Model.FileLoc');
        if (fileLocation != "" && fileLocation != undefined && fileLocation != null) {
            $.ajax({
                url: '@Url.Action("InsertDataFromExcelDynamic", "DynamicMagt")',
                data: {
                    fileLoc: fileLocation,
                    PageID: '@Model.PAG_ID',
                    ActID: '@Model.ACT_ID',
                    PageKey: '@Model.PAG_KEY'
                },
                dataType: 'json',
                type: 'GET'
            }).done(function (result) {
                $('#modalControl').modal('hide');
                DevExpress.ui.dialog.alert(result.Message, "Success");
                $('#btnReload_@ViewBag.MenuID').trigger('click');
            }).fail(function (result) {
                $('#modalControl').modal('hide');
                DevExpress.ui.dialog.alert(result.Message, "Failed");
            })

            
        }
        else {
            DevExpress.ui.dialog.alert("Failed To Save Data!", "Failed");
        }
    });

    $("#btnDownloadTemplate_@ViewBag.Thread").on("click", function () {
        debugger;

        console.log("btnDownloadTemplate start");

        $.ajax({
            url: '@Url.Action("DownloadFileTemplateImportExcel", "DynamicMagt")',
            type: "GET",
            data: {
                PageID: '@Model.PAG_ID',
                ActID: '@Model.ACT_ID',
                PageKey: '@Model.PAG_KEY'
            },
            dataType: 'json',
            success: function (result) {
                console.log("result btnDownloadTemplate start" + result.Result);

                if (result.Result) {//success
                    if (result.fileName != '' || result.fileName != null) {
                        var link = $("<a href='" + getLanguages() + "/DynamicMagt/Download?fileLink=" + result.downloadExcelPath + "&fileName=" + result.fileName + "'></a>");
                        location.href = link[0].href;
                    }
                    else {
                        DevExpress.ui.dialog.alert("File does not exists!", "Error");
                    }
                    
                    LoadingPage(0);
                } else {//fail
                    LoadingPage(0);
                    DevExpress.ui.dialog.alert("", "Error");
                    return;
                }

            }, error: function (result) {
                LoadingPage(0);
                return;
            }
        });
    });

    function OnUploadedFileDynamicImport@(ViewBag.Thread)(e) {
        debugger;
        console.log(e);
        var result = JSON.parse(e.request.response);
        fileLocation = result.data.FileLoc;
    }
</script>

<div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title" id="@modelId">@_loc.GetLocalizedString(Model.PAG_TITLE)</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div id="menutoolbar_@(ViewBag.Thread)">
        @await Component.InvokeAsync("AccessToolbar", new { lstNewToolbar = lstNewToolbar, pageSetting = pageSetting,  threadID = ViewBag.Thread })
    </div>
    <div class="modal-body">
        <div class="row">
            <form id="form" method="post" enctype="multipart/form-data">
                <div class="row">
                    <div class="fileuploader-container">
                        @(Html.DevExtreme().FileUploader()
                            .ID(UploadFileID)
                            .Name("myFile")
                            .ChunkSize(10000000)
                            .MaxFileSize(50000000000)
                            .AllowedFileExtensions(new[] { ".xls", ".xlsx" })
                            .SelectButtonText(@_loc.GetLocalizedString("Select file"))
                            .UploadUrl(Url.Action("UploadFilePopup", "DynamicMagt", new { PageID = Model.PAG_ID, ActID = Model.ACT_ID, PageKey = Model.PAG_KEY}))
                            .OnUploaded("OnUploadedFileDynamicImport" + ViewBag.Thread)
                            //.OnUploadAborted("OnUploadAbortedPopupFileInventoryCurrentStock" + ViewBag.Thread)
                            //.OnUploadError("OnUploadErrorFileInventoryCurrentStock" + ViewBag.Thread)
                            //.AllowCanceling(true)
                            //.ShowFileList(true)
                    )
                    </div>
                </div>

            </form>

        </div>
        <div class="row">
            <div class="col-12">

            </div>
        </div>

    </div>
    @*<div class="modal-footer">
            <button type="button" class="btn btn-primary" id="btnSave_@ViewBag.Thread">Save</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>*@
</div>